import json
import numpy as np
from scipy.special import binom

def generalized_zipf(r, C, a, b):
    return C / (r + b)**a

def calc_rare_hit(users, dc_prob, prob_rare_series):
    res = 0
    for cnt in range(2, 51):
        cnt_hit = 0
        for u_cnt in range(1, cnt + 1):
            for u in range(1, u_cnt + 1):
                requests = (cnt / u_cnt) * u
                cnt_hit += users[cnt][u_cnt-1]*((requests - 1) / requests) * binom(u_cnt, u) * (dc_prob**u) * (1 - dc_prob)**(u_cnt - u)
        res += cnt_hit * prob_rare_series[cnt]
    return res

def main():
    users = {}
    with open('users.json', 'r') as f:
        for line in f.readlines():
            js = json.loads(line)
            users.setdefault(js['type'], []).append(js['prob'])

    rps = np.array([1315615, 1278978, 1257027, 1199552, 1171132, 1126856, 1160106, 1147532, 1125557, 1132688, 1109176, 1105650, 1112110, 1100720, 1085988, 1067239, 1039796, 1000865, 973816, 947740, 924349, 903902, 872128, 840771, 802251, 771282, 743230, 727016, 715458, 710785, 702249, 695095, 686864, 678408, 675746, 708938, 675565, 668981, 673363, 669166, 629354, 617750, 623975, 617768, 614119, 619865, 617373, 612561, 611008, 614618, 625703, 628119, 629349, 635946, 641513, 645573, 645553, 649250, 654850, 664062, 670925, 684123, 701426, 708297, 719425, 727557, 735710, 753934, 764791, 771777, 738638, 726500, 745989, 760243, 776294, 787301, 804517, 816608, 835828, 842804, 856223, 865871, 890644, 904902, 905536, 938960, 955560, 966924, 982795, 995171, 1010504, 1049192, 1093934, 1098031, 1115276, 1131454, 1140391, 1173391, 1193147, 1207610, 1227169, 1244952, 1264270, 1286991, 1299631, 1318988, 1336894, 1368842, 1384618, 1410014, 1428786, 1440953, 1457871, 1464732, 1484460, 1492994, 1510184, 1512351, 1530814, 1538211, 1537830, 1550223, 1573619, 1573237, 1585298, 1593525, 1598744, 1606853, 1609201, 1627763, 1623282, 1634203, 1644174, 1657916, 1653826, 1673805, 1671080, 1674174, 1680027, 1686245, 1684425, 1701566, 1705019, 1704282, 1694762, 1699227, 1703531, 1685732, 1696809, 1697023, 1703424, 1708426, 1708212, 1708733, 1710458, 1715310, 1698918, 1714326, 1711239, 1711111, 1704561, 1719227, 1716662, 1724177, 1728050, 1719920, 1724914, 1718627, 1714773, 1714837, 1725126, 1730642, 1724665, 1722983, 1749212, 1751885, 1754676, 1749016, 1733471, 1738126, 1754324, 1756845, 1744232, 1730037, 1724817, 1725680, 1730146, 1739486, 1730922, 1723770, 1730091, 1715729, 1686585, 1693696, 1700575, 1715313, 1696432, 1695630, 1694599, 1696665, 1683553, 1677997, 1664901, 1658568, 1630725, 1647947, 1654362, 1633344, 1632215, 1635046, 1633266, 1625319, 1598483, 1600242, 1616290, 1603817, 1575934, 1562261, 1574355, 1576708, 1552929, 1549703, 1562660, 1560621, 1555099, 1546504, 1554457, 1541721, 1562553, 1571873, 1576561, 1584726, 1576980, 1586649, 1594498, 1596303, 1589006, 1557928, 1552638, 1549974, 1530957, 1534318, 1547140, 1528754, 1529973, 1529480, 1541850, 1538335, 1533834, 1549147, 1550928, 1550015, 1536694, 1557395, 1560700, 1547502, 1546716, 1552239, 1542015, 1538575, 1537713, 1530270, 1536072, 1515591, 1514165, 1493859, 1491248, 1478195, 1451597, 1456760, 1449810, 1428627, 1411466, 1377470, 1387861, 1371523, 1354695, 1360109, 1328367, 1291087, 1277538, 1267657, 1235050, 1201305, 1192509, 1169231, 1129515, 1108986])
    single = np.array([0.2700440478407437, 0.25806542411206446, 0.2572387068853732, 0.25221749453129166, 0.2485134041252395, 0.2509211469788509, 0.23994703932226882, 0.23074214923853975, 0.22818124715141036, 0.22238427528145438, 0.21421307348878807, 0.20732419843530955, 0.20290169137944988, 0.19792317755650846, 0.19206749982504412, 0.18904856363007724, 0.18902169271664826, 0.19411808785400628, 0.19578133856909313, 0.19618355245109417, 0.19422101392439436, 0.19729461822188687, 0.2003306854039774, 0.20162565074199754, 0.20669466289228683, 0.20818714815074124, 0.2091236898402917, 0.21016868954741025, 0.20649569925837716, 0.2088409293949647, 0.21028865829641624, 0.2080622073241787, 0.207370017936593, 0.20449051308357213, 0.20375407327605344, 0.1914441037156987, 0.19616913250390414, 0.19848994216577154, 0.19597007854604426, 0.19126195891602382, 0.20395993351913233, 0.20713881019830027, 0.20342321407107655, 0.20185733155488791, 0.20214323282621122, 0.20278286401071202, 0.20361758612702532, 0.20789929492736234, 0.19746877291295695, 0.2045433098282185, 0.21067822912787695, 0.21143445748337497, 0.20758116720611297, 0.213959990313643, 0.21280940526536485, 0.21374499862912483, 0.21601324755674592, 0.21807778205621872, 0.21774757578071313, 0.2202234128740991, 0.22141222938480457, 0.21913164737919935, 0.22127922261222138, 0.22073791079165944, 0.22146575390068457, 0.2229543527173816, 0.22497451441464708, 0.22392145731589239, 0.22459992337775941, 0.22787800102879457, 0.24390973656919898, 0.2533475567790778, 0.2481323451150084, 0.2508040192412163, 0.25392570340618376, 0.25426996790300027, 0.25763532653753746, 0.25816793369646146, 0.2586333551879095, 0.2637327302670609, 0.2658618140367638, 0.2693530560556942, 0.27200654807083413, 0.2734285038600865, 0.26988766873984027, 0.26877289767402235, 0.27117606429737534, 0.2737702239265961, 0.2770028337547505, 0.2777201104131853, 0.27911121578934867, 0.2783513408413331, 0.2729789914199577, 0.27773441733430115, 0.2817374353971573, 0.2840875545978891, 0.2872777845493344, 0.28803698000069883, 0.29232106354036846, 0.2937736520896647, 0.29633897205682347, 0.29793357494907435, 0.3000719782957754, 0.3026990864737982, 0.305268187662498, 0.3065395591165348, 0.309093316298824, 0.30928624340866223, 0.30793980722480857, 0.3112756327242141, 0.31319595796711336, 0.31578476189022125, 0.31683187332761265, 0.31873066199140865, 0.319871198954502, 0.32124040686030886, 0.321378719414323, 0.32438236890774697, 0.32371600991367994, 0.32652087392431856, 0.32198552505803635, 0.3249635697573833, 0.3243796624214629, 0.3253692863821535, 0.3257911130904095, 0.3289091793351218, 0.32839216284783557, 0.3285502780901551, 0.32906889816747564, 0.33116368906284266, 0.33127638943818755, 0.3298965917942875, 0.3254910976575472, 0.32454418679836616, 0.32634569779408473, 0.32650039879197396, 0.3276049022189243, 0.32691285374160634, 0.3271072429193102, 0.32780764361050735, 0.3278804339759859, 0.32720623237652846, 0.3271013402196691, 0.32606986402485033, 0.32217562111966164, 0.32104303898184294, 0.3209515999415332, 0.3252616667418071, 0.32472835775859277, 0.32527078301236934, 0.3256793376164713, 0.32480013767058097, 0.3247348689741086, 0.325324670384431, 0.32574491744316436, 0.324822918306312, 0.32267713921448826, 0.321609775503609, 0.32271237389984686, 0.3234722937319671, 0.32609158604473526, 0.32578711246391545, 0.32565467168260265, 0.3253030286333712, 0.3245693122305489, 0.32598376668682266, 0.32511128091023667, 0.324549771416369, 0.3222828910882082, 0.325265899907688, 0.3250064053292339, 0.3257715922761611, 0.3258644432397016, 0.32703282620896434, 0.32247892193742095, 0.323498973962332, 0.32262879300793995, 0.32346530849346145, 0.32557683399376164, 0.32344260427609967, 0.321151623075327, 0.31855627559631045, 0.3190779666925042, 0.32239021477575336, 0.3221402618364731, 0.32319259654165317, 0.318521095907513, 0.31782664534235977, 0.31895544686588995, 0.3180261867882606, 0.3205091524087461, 0.31645615362332863, 0.3156283258774387, 0.31489712439540507, 0.31467297825735413, 0.31499732118861107, 0.31500820545710057, 0.3130329140201577, 0.3124096025077319, 0.3106423483716585, 0.30819819750254374, 0.3110923321078643, 0.3109127810001916, 0.3094820351049821, 0.3045982615094513, 0.30331133222124257, 0.30141407986885577, 0.30241088221464674, 0.3020576333387452, 0.3019835527563139, 0.3004929999155067, 0.3001398494695503, 0.30358346006807707, 0.3004714286964097, 0.2977504037023059, 0.2943665019138717, 0.2912850411248187, 0.29071710808885326, 0.2896799006577297, 0.29069111084614274, 0.2908008028699316, 0.2908428260124682, 0.28796411247488257, 0.2891156789508792, 0.2917653474151806, 0.29122976726862654, 0.29121937757043137, 0.2907828329509684, 0.28499897283484144, 0.2821506572095837, 0.283557058686597, 0.28150039817608846, 0.2824303415388908, 0.27917201599093433, 0.27973192816798764, 0.2787710102655949, 0.2806119045491332, 0.2836941116662644, 0.2866025435420233, 0.2874325633849342, 0.28456710410547126, 0.2860234970846982, 0.2848397688638391, 0.28194398837222995, 0.2840729869089193, 0.28507401208253785, 0.2848785549826507, 0.28346101466845647, 0.28477397162926366, 0.28510722352365525, 0.2855090629610143, 0.28359983613061807, 0.2842732515386928, 0.2820568962915638, 0.2828922919202922, 0.2823104590494875, 0.28322911251968685, 0.28441818560157295, 0.2821645703835566, 0.28132005264611737, 0.28383319904299437, 0.282679527142269, 0.28489029160091456, 0.28425412924727056, 0.28360911789666254, 0.2837242336793499, 0.28320037981610036, 0.284477352446734, 0.2857377081931142, 0.2845341717235509, 0.28461867417109826, 0.28322018273489163, 0.28493424567081316, 0.2847183604724604, 0.2847309636916089, 0.28231243661243743, 0.28086986369625633, 0.27592126807483813, 0.2796591604579156, 0.2782903088637714, 0.2784136362284331, 0.27914333293627536, 0.2784591716934537, 0.27645352345990404, 0.27616059920721775, 0.27654672173419964, 0.2778856411822774, 0.27335511900060055])
    high = [0.33804874526362194, 0.32334801693226933, 0.31780542502269243, 0.3193525582884277, 0.3180888234631109, 0.321997664297834, 0.312980882781401, 0.3089987904476738, 0.30909318675109304, 0.3085527523907731, 0.309116857919753, 0.30428526206303985, 0.2999667299098111, 0.29464804855003995, 0.29449865007716475, 0.2941374893533688, 0.3266948516824454, 0.3764144015426656, 0.34484235214866055, 0.33293413805474076, 0.33612953548930113, 0.3472832231812741, 0.3486311642327732, 0.3505698935857683, 0.33631120434876366, 0.33877881241880403, 0.3428857823284851, 0.3415894560779955, 0.3458959156232791, 0.3465422033385623, 0.34884919736446757, 0.3499464102029219, 0.34833678865102846, 0.3505589556726925, 0.3481604034652073, 0.37456731054055503, 0.35081746390058693, 0.35118635656319086, 0.3542621141939786, 0.3564720861490273, 0.373921513170648, 0.3685034399028733, 0.3817973476501462, 0.38415392186063374, 0.38435384673003115, 0.3805393109790035, 0.38572791489099784, 0.3897832215893601, 0.39481643448203624, 0.3966691505943529, 0.3955694634674918, 0.39572437706867647, 0.396862472173627, 0.3935790145704195, 0.3949538045214984, 0.39451928751667126, 0.39121187570966287, 0.39133769734308815, 0.3897610139726655, 0.3882303158440025, 0.3821634310839513, 0.38683833170350945, 0.3815185065851565, 0.3802726822222881, 0.37719428710428465, 0.37633340068200843, 0.3779967650296992, 0.3730220417171795, 0.36926559020699773, 0.36765671949280687, 0.3903806736182, 0.39960770818995184, 0.40044826398244476, 0.39695728865639013, 0.3935480629761405, 0.391096924810206, 0.3887549921257102, 0.384868872212861, 0.3848770321166556, 0.3782919872236012, 0.37483108956428407, 0.3716823868682517, 0.36982902259488637, 0.3681978822016086, 0.3680383772704785, 0.36163521342762206, 0.35912658545774206, 0.35753171914235243, 0.3527388722978851, 0.3505297079597376, 0.35074873528457085, 0.3422586142479165, 0.3296679689999579, 0.36464544261500814, 0.3606865027132297, 0.35797831816406145, 0.3487382836237746, 0.34877206319121246, 0.3437614979545689, 0.34124758821142587, 0.33683298714358006, 0.3329421535930703, 0.32900883513806384, 0.32668293717671687, 0.3219567708064828, 0.31946386168790014, 0.3160377711321915, 0.3153453795251753, 0.3162388471043999, 0.3122344884518877, 0.309037882510047, 0.3054499348694926, 0.30199242594166426, 0.3011929827436009, 0.30058202982902876, 0.2971009930381502, 0.29792661026735817, 0.29640407550892617, 0.2946713317228612, 0.2923454584579099, 0.2938634309384002, 0.29383708021362087, 0.2948553620666756, 0.294183266729679, 0.2917659645063578, 0.28992516590577494, 0.2917321347257597, 0.290314048640417, 0.28957973553334854, 0.2854592468313876, 0.286427127264394, 0.2871638346031674, 0.2931113130362115, 0.29475015622021866, 0.2929201741900297, 0.2937403102511941, 0.29348924049117936, 0.2940034906765963, 0.2940964639258774, 0.29381614178248117, 0.29388723154785756, 0.294406446767272, 0.29454041274613363, 0.29529796125289126, 0.29976775500040714, 0.29899772072830766, 0.2989977875365931, 0.29234599568614705, 0.29153074977796556, 0.29153641406156544, 0.29217798974301173, 0.29154203928060096, 0.2899880108557954, 0.29135856801501464, 0.2895715650428131, 0.29048568480333004, 0.29288111609859924, 0.2944521637074862, 0.2932471735391725, 0.2926706683552382, 0.2876576432289604, 0.290262426078697, 0.29191186150797305, 0.2915559133430036, 0.2897404588987587, 0.2911740080933997, 0.2897970565489062, 0.29107421214725476, 0.29247019867935875, 0.2907646615975746, 0.29137813701723814, 0.2898329059389521, 0.2897432254959659, 0.28782001911800636, 0.29371797129221616, 0.2945113406416517, 0.29463388112677213, 0.29240613007542526, 0.2902984820628669, 0.29065786945250227, 0.2917499846094564, 0.2941881611639046, 0.293807819143325, 0.2918082098822164, 0.2928739686587041, 0.29159751518242083, 0.297697419755327, 0.29758273420999076, 0.2957169647159144, 0.29693984696334197, 0.29359900721985144, 0.29677297521928, 0.29575028830447325, 0.29822884390114873, 0.29450156564691354, 0.29480159014710433, 0.2949655512275175, 0.2938819199943384, 0.30025333426964135, 0.2993708245292972, 0.3016774642675342, 0.29763700411860095, 0.2981895019583747, 0.2975000120585951, 0.29896702386975116, 0.30158615537999706, 0.30096496413723234, 0.29876437541632384, 0.3020655979757569, 0.3027731329883074, 0.3061087416256752, 0.3093552711806113, 0.30618905549824427, 0.31195719147478945, 0.30964678368362114, 0.30855016501259186, 0.31030233499626253, 0.3078422875563046, 0.30915263711170604, 0.30982211037173657, 0.3143170099856465, 0.3172349798638836, 0.3207441158025418, 0.31801763528749133, 0.31597538163165173, 0.31620674760621376, 0.31452333515819353, 0.31715790340794475, 0.31749707049936865, 0.32054625278250853, 0.3181031371447093, 0.31969248942719436, 0.3195214904437596, 0.322804224500819, 0.3228828132741465, 0.3238489184070944, 0.3220617165699815, 0.31629959792750373, 0.3098017696333595, 0.3067412743697636, 0.30954363839088883, 0.31038676467329457, 0.3092247631112892, 0.31208487434865256, 0.30889564717808743, 0.3095274210842901, 0.31111132730161817, 0.3097303253192575, 0.3091077652470867, 0.30995315486522584, 0.3154176080385421, 0.3165511301503534, 0.3166108542104023, 0.3182185636912922, 0.31753572115076567, 0.3181204289235167, 0.31616276032574825, 0.3161742489397573, 0.3166739623155417, 0.31857595502331704, 0.31645241992491446, 0.31695256392662735, 0.3139943960960163, 0.3117206423104914, 0.3120452526640095, 0.313710999498614, 0.31319740244412736, 0.31397616687920066, 0.3143599773215293, 0.3147848650429721, 0.3129948062159869, 0.3151956388896472, 0.31364977973256175, 0.3148170196084125, 0.31477143604438773, 0.31952435358357095, 0.32107743809492173, 0.32315718813712724, 0.32449917831442665, 0.32567983412426893, 0.3241265621844517, 0.32374924762771, 0.3280604024128578, 0.326724686902993, 0.32853169242328567, 0.32659585659292306, 0.322132950868293, 0.32366955038206074]
    f5 = [0.101, 0.112, 0.116, 0.112, 0.111, 0.116, 0.114, 0.118, 0.116, 0.110, 0.107, 0.102, 0.110, 0.108, 0.108, 0.106, 0.102, 0.079, 0.079, 0.082, 0.084, 0.086, 0.087, 0.091, 0.098, 0.097, 0.096, 0.096, 0.097, 0.096, 0.095, 0.095, 0.099, 0.098, 0.096, 0.094, 0.113, 0.111, 0.111, 0.117, 0.129, 0.133, 0.135, 0.131, 0.125, 0.125, 0.117, 0.113, 0.121, 0.116, 0.110, 0.110, 0.108, 0.110, 0.112, 0.112, 0.109, 0.109, 0.109, 0.107, 0.113, 0.107, 0.105, 0.103, 0.100, 0.099, 0.097, 0.095, 0.096, 0.094, 0.099, 0.102, 0.102, 0.098, 0.097, 0.097, 0.094, 0.093, 0.093, 0.094, 0.092, 0.092, 0.091, 0.090, 0.098, 0.086, 0.083, 0.084, 0.084, 0.087, 0.083, 0.081, 0.079, 0.081, 0.080, 0.080, 0.086, 0.081, 0.080, 0.079, 0.079, 0.079, 0.079, 0.081, 0.077, 0.076, 0.075, 0.075, 0.076, 0.077, 0.076, 0.075, 0.074, 0.075, 0.073, 0.074, 0.072, 0.073, 0.073, 0.076, 0.080, 0.077, 0.075, 0.074, 0.072, 0.073, 0.074, 0.073, 0.072, 0.072, 0.073, 0.074, 0.074, 0.073, 0.072, 0.071, 0.070, 0.070, 0.069, 0.069, 0.074, 0.074, 0.072, 0.075, 0.076, 0.074, 0.075, 0.075, 0.072, 0.075, 0.076, 0.072, 0.073, 0.073, 0.071, 0.074, 0.076, 0.072, 0.073, 0.072, 0.074, 0.079, 0.073, 0.072, 0.073, 0.071, 0.071, 0.072, 0.075, 0.073, 0.072, 0.073, 0.072, 0.072, 0.073, 0.070, 0.071, 0.070, 0.078, 0.074, 0.074, 0.070, 0.067, 0.068, 0.068, 0.069, 0.071, 0.068, 0.068, 0.068, 0.069, 0.069, 0.069, 0.073, 0.071, 0.071, 0.074, 0.075, 0.073, 0.071, 0.070, 0.072, 0.071, 0.072, 0.073, 0.073, 0.074, 0.076, 0.075, 0.077, 0.078, 0.080, 0.082, 0.081, 0.080, 0.079, 0.084, 0.086, 0.086, 0.087, 0.089, 0.090, 0.089, 0.087, 0.087, 0.088, 0.088, 0.090, 0.096, 0.096, 0.095, 0.097, 0.098, 0.096, 0.095, 0.094, 0.094, 0.099, 0.098, 0.097, 0.096, 0.096, 0.094, 0.095, 0.095, 0.096, 0.094, 0.096, 0.095, 0.095, 0.093, 0.093, 0.091, 0.091, 0.091, 0.092, 0.090, 0.089, 0.090, 0.090, 0.089, 0.090, 0.091, 0.096, 0.095, 0.093, 0.093, 0.094, 0.090, 0.092, 0.092, 0.096, 0.096, 0.096, 0.094, 0.091, 0.090, 0.091, 0.089, 0.092, 0.093, 0.093, 0.094, 0.097, 0.097, 0.100, 0.102, 0.102]
    total_rps = rps * f5 + rps

    single = sum(total_rps * single) / sum(total_rps)
    high = sum(total_rps * high) / sum(total_rps)
    f5 = sum(total_rps * f5) / sum(total_rps)

    prob_rare_series = {}
    total_series = 0
    for i in range(2, 51):
        prob_rare_series[i] = sum(total_rps) * generalized_zipf(i-1, 0.1, 1.11, -0.12) / i
        total_series += prob_rare_series[i]
    for i in range(2, 51):
        prob_rare_series[i] = prob_rare_series[i] / total_series

    dc_prob = 33 / (17*2 + 33*2)
    print("Calculate theoretical meth expect")
    print(f'uniq: {single}, high: {high}, f5: {f5}, dc: {dc_prob}')

    E_perfect_cache_hit = 1 * (high + f5) + (1 - f5 - high - single) * calc_rare_hit(users, dc_prob, prob_rare_series)
    print(f"E[cache_hit]: {E_perfect_cache_hit}")

    dc_prob = 17 / (17*2 + 33*2)
    print("Calculate theoretical meth expect")
    print(f'uniq: {single}, high: {high}, f5: {f5}, dc: {dc_prob}')

    E_perfect_cache_hit = 1 * (high + f5) + (1 - f5 - high - single) * calc_rare_hit(users, dc_prob, prob_rare_series)
    print(f"E[cache_hit]: {E_perfect_cache_hit}")
    

if __name__ == '__main__':
    main()
